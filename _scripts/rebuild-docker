#!/usr/bin/env zsh
set -euo pipefail

# Docker Rebuild Script
# Rebuilds the Docker development container with clock synchronization
# Usage: _scripts/rebuild-docker

# Repo root
REPO_PATH="$(cd "$(dirname "$0")/.." && pwd)"
export REPO_PATH

# Change to monorepo directory
cd "$REPO_PATH"

echo "ğŸ”§ Starting Docker container rebuild process..."
echo ""

# Step 1: Stop and remove existing containers
echo "ğŸ“¦ Stopping and removing existing containers..."
docker-compose -f docker-compose.yml -f docker-compose.claude.yml down
echo "âœ… Containers stopped and removed"
echo ""

# Step 2: Fix clock synchronization (macOS Docker Desktop time drift issue)
echo "ğŸ• Synchronizing Docker clock with host..."
if docker run --rm --privileged alpine hwclock -s 2>/dev/null; then
    echo "âœ… Clock synchronized successfully"
else
    echo "âš ï¸  Clock sync failed (may not be needed on this system)"
fi
echo ""

# Step 3: Rebuild the Docker images
echo "ğŸ”¨ Building Docker images..."
echo "  â†’ Building base image..."
docker-compose -f docker-compose.yml build
echo "  â†’ Building Claude image..."
docker-compose -f docker-compose.yml -f docker-compose.claude.yml build
echo "âœ… Docker images built successfully"
echo ""

# Step 4: Start container in detached mode
echo "ğŸš€ Starting container in detached mode..."
docker-compose -f docker-compose.yml -f docker-compose.claude.yml up -d
echo "âœ… Container started in background"
echo ""

echo "ğŸ‰ Docker rebuild complete!"
echo "ğŸ’¡ Use 'aimedocker' to connect to the container"